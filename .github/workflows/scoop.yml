name: App Bundles
on:
  push:
    branches:
      - latest
    paths:
      - '.github/workflows/scoop.yml'
      - 'windows/scoop/**'

env:
  SCOOP: 'C:\bin'

jobs:
  apps:
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell
        working-directory: windows/scoop
    strategy:
      matrix:
        bundle: ['bn-dev', 'bn-ops', 'bn-common']
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

      - name: Install Scoop
        run: iex "& {$(irm get.scoop.sh)} -RunAsAdmin"

      - name: Add shims to path
        run: echo "C:\bin\shims" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install packages
        run: .\bin\import.ps1 ${{ matrix.bundle }}

      - name: Get list of apps
        run: scoop list

  secrets:
    needs: [apps]
    uses: bn-digital/vault/.github/workflows/import-secrets.yml@latest
    secrets: inherit

  manifest:
    needs: [secrets]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

      - name: Upload S3
        uses: betahuhn/do-spaces-action@v2
        with:
          access_key: ${{ secrets.SPACES_ACCESS_KEY_ID }}
          secret_key: ${{ secrets.SPACES_SECRET_ACCESS_KEY }}
          space_name: bn-digital
          space_region: fra1
          source: windows/scoop/apps
          out_dir: windows/scoop/apps


